name: Deploy API to Proxmox VM

on:
  push:
    branches:
      - vm-deploy

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: carshare-backend

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- Docker Hub へのログインとビルド/プッシュ ---
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.REPO_NAME }}:latest 

      # ------------------------------------------------------------------
      # --- SSH 環境のセットアップと Cloudflared のインストール ---
      # ------------------------------------------------------------------
      - name: Setup SSH Environment and Install Cloudflared
        run: |
          # .ssh ディレクトリを作成
          mkdir -p $HOME/.ssh
          
          # 鍵をファイルに保存
          echo "${{ secrets.DEPLOY_KEY }}" > $HOME/.ssh/deploy_key
          chmod 600 $HOME/.ssh/deploy_key
          
          # ssh-agent を起動してバックグラウンドで実行
          eval "$(ssh-agent -s)"
          
          # 鍵をエージェントに追加
          ssh-add $HOME/.ssh/deploy_key
          
          # cloudflared のインストール
          sudo apt update
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          sudo mv cloudflared /usr/local/bin/cloudflared
          sudo chmod +x /usr/local/bin/cloudflared

      # ------------------------------------------------------------------
      # --- SSH 設定ファイルの作成 (ProxyCommand) ---
      # ------------------------------------------------------------------
      - name: Create SSH Config with ProxyCommand
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          CF_ID: ${{ secrets.CF_CLIENT_ID }}
          CF_SECRET: ${{ secrets.CF_CLIENT_SECRET }}
        run: |
          # SSH設定ファイルを作成
          cat > $HOME/.ssh/config << EOF
          Host ${DEPLOY_HOST}
              User ${{ secrets.DEPLOY_USER }}
              IdentityFile $HOME/.ssh/deploy_key
              StrictHostKeyChecking no
              ProxyCommand /usr/local/bin/cloudflared access ssh --hostname %h --client-id ${CF_ID} --client-secret ${CF_SECRET}
          EOF
          
          chmod 600 $HOME/.ssh/config

      # ------------------------------------------------------------------
      # --- 標準の SSH コマンドでデプロイを実行 ---
      # ------------------------------------------------------------------
      - name: Execute Deployment Script
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        run: |
          # SSH エージェントを再起動
          eval "$(ssh-agent -s)"
          ssh-add $HOME/.ssh/deploy_key
          
          # デプロイコマンドを実行
          ssh ${DEPLOY_HOST} << 'ENDSSH'
            cd /home/${DEPLOY_USER}/main/itemshare-backend
            /usr/bin/docker compose pull api
            /usr/bin/docker compose up -d --no-deps api
            /usr/bin/docker image prune -f
          ENDSSH