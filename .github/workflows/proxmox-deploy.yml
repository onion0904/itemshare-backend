name: Deploy API to Proxmox VM

on:
  push:
    branches:
      - vm-deploy # vm-deployãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: carshare-backend # GitHubç’°å¢ƒè¨­å®šï¼ˆSecretsç®¡ç†ã«ä¾¿åˆ©ï¼‰

    steps:
      # ========================================
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # ========================================
      - name: Checkout Code
        uses: actions/checkout@v4

      # ========================================
      # 2. Docker Hubã¸ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ—ãƒƒã‚·ãƒ¥
      # ========================================
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: . # DockerfileãŒå­˜åœ¨ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.REPO_NAME }}:latest

      # ========================================
      # 3. cloudflaredã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆCloudflare AccessçµŒç”±ã®SSHæ¥ç¶šã«å¿…è¦ï¼‰
      # ========================================
      - name: Setup cloudflared
        run: |
          # cloudflaredã®æœ€æ–°ç‰ˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb
          
          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
          cloudflared --version

      # ========================================
      # 4. Cloudflare Accessèªè¨¼ã®è¨­å®šã¨ãƒ†ã‚¹ãƒˆ
      # ========================================
      - name: Setup Cloudflare Access Authentication
        run: |
          # èªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆå€¤ã¯è¡¨ç¤ºã—ãªã„ï¼‰
          if [ -z "${{ secrets.CF_CLIENT_ID }}" ] || [ -z "${{ secrets.CF_CLIENT_SECRET }}" ]; then
            echo "âŒ Error: CF_CLIENT_ID or CF_CLIENT_SECRET is not set"
            exit 1
          fi
          echo "âœ… Cloudflare Access credentials are set"
          
          # SSHç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # ç§˜å¯†éµã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # cloudflaredã®ãƒ©ãƒƒãƒ‘ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ
          # ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèªè¨¼æƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å—ã‘å–ã‚‹
          cat << 'SCRIPT_EOF' > ~/.ssh/cloudflared-wrapper.sh
          #!/bin/bash
          exec cloudflared access ssh --hostname "$1"
          SCRIPT_EOF
          chmod +x ~/.ssh/cloudflared-wrapper.sh
          
          # SSHè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
          # ProxyCommandã§ãƒ©ãƒƒãƒ‘ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨
          cat << EOF > ~/.ssh/config
          Host deploy-vm
            HostName ${{ secrets.DEPLOY_HOST }}
            User ${{ secrets.DEPLOY_USER }}
            IdentityFile ~/.ssh/id_rsa
            ProxyCommand ~/.ssh/cloudflared-wrapper.sh %h
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
          chmod 600 ~/.ssh/config
          
          echo "âœ… SSH config created successfully"

      # ========================================
      # 5. SSHçµŒç”±ã§Proxmox VMã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œ
      # ========================================
      - name: Deploy to Proxmox VM via SSH
        env:
          # cloudflaredãŒç’°å¢ƒå¤‰æ•°ã‹ã‚‰è‡ªå‹•çš„ã«èª­ã¿å–ã‚‹
          CF_ACCESS_CLIENT_ID: ${{ secrets.CF_CLIENT_ID }}
          CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_CLIENT_SECRET }}
        run: |
          # ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
          echo "ğŸ” Authenticating via Cloudflare Access..."
          
          # SSHæ¥ç¶šã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
          # -T: ç–‘ä¼¼ç«¯æœ«ã®å‰²ã‚Šå½“ã¦ã‚’ç„¡åŠ¹åŒ–ï¼ˆæ¨™æº–å…¥åŠ›ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã®ãŸã‚ï¼‰
          ssh -T deploy-vm << 'EOF'
            set -e  # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚‰å³åº§ã«çµ‚äº†
            
            echo "ğŸ“‚ Navigating to application directory..."
            cd /home/${{ secrets.DEPLOY_USER }}/main/itemshare-backend
            
            echo "ğŸ“¥ Pulling latest Docker image for api service..."
            /usr/bin/docker compose pull api
            
            echo "ğŸ”„ Restarting api service..."
            /usr/bin/docker compose up -d --no-deps api
            
            echo "ğŸ§¹ Cleaning up unused Docker images..."
            /usr/bin/docker image prune -f
            
            echo "âœ… Deployment completed successfully!"
          EOF
          
          echo "ğŸ‰ Deployment finished!"

      # ========================================
      # 6. ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      # ========================================
      - name: Deployment Status
        if: success()
        run: |
          echo "âœ… Deployment to Proxmox VM completed successfully!"
          echo "ğŸ“¦ Image: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.REPO_NAME }}:latest"
          echo "ğŸš€ Service: api"
